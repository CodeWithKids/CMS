import{L as V,r as O,g as Q,a as X,b as ee,c as se,m as q,d as K,j as e,S as d,A as ne,C as te,e as ae,f as ie,B as re,h as F,i as f,k as N,l as y,n as P,o as b,T as L,p as w,q as m,s as a,t as E,u as i,v as A,w as j,x as Z,y as M,z as le,D as H,E as Y,F as ce}from"./index-C7xgdnS2.js";function de(t){return t.overviewType?t.overviewType:t.type==="school"?"SCHOOL":t.name.toLowerCase().includes("miradi")?"MIRADI":"ORGANISATION"}function oe(t){return t.status!=="INACTIVE"}function he(t,I,g,R,u){const p=new Map(R.map(n=>[n.sessionId,n])),o=new Map;for(const n of g){const r=o.get(n.classId)??[];r.push(n),o.set(n.classId,r)}const T=I.filter(n=>n.status==="active");function S(n){const r=u.filter(x=>x.learnerId===n&&x.status==="active"),J=new Set(r.map(x=>x.classId)),z={};for(const x of J){const D=o.get(x)??[];for(const _ of D){const W=p.get(_.id),U=(W==null?void 0:W.learningTrack)??_.learningTrack;z[U]=(z[U]??0)+1}}const B=Object.entries(z);return B.length===0?null:(B.sort((x,D)=>D[1]-x[1]),B[0][0])}const c=new Map;for(const n of T)n.organizationId&&c.set(n.organizationId,(c.get(n.organizationId)??0)+1);let v=0,s=0,k=0;const h=[];for(const n of t){if(!oe(n))continue;const r=de(n);r==="SCHOOL"?v+=1:r==="ORGANISATION"?s+=1:k+=1,h.push({organisationId:n.id,organisationName:n.name,type:r,activeLearners:c.get(n.id)??0})}const C=new Map,G=Object.keys(V);for(const n of G)C.set(n,0);for(const n of T){const r=n.learningTrackId??S(n.id);r&&C.set(r,(C.get(r)??0)+1)}const $=G.map(n=>({learningTrackId:n,learningTrackName:V[n],learnerCount:C.get(n)??0}));return{activeSchools:v,activeOrganisations:s,activeMiradis:k,partners:h,learnersByTrack:$}}function l({title:t,value:I,description:g}){return e.jsxs(f,{children:[e.jsx(N,{className:"pb-2",children:e.jsx(y,{className:"text-sm font-medium text-muted-foreground",children:t})}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:I}),g&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:g})]})]})}function xe(t){return new Intl.DateTimeFormat("en-ZA",{day:"numeric",month:"short",year:"numeric"}).format(new Date(t))}const me=()=>Z.filter(t=>t.status==="pending"),je={SCHOOL:"School",ORGANISATION:"Organisation",MIRADI:"Miradi"};function pe(){const[t,I]=O.useState(!0),[g,R]=O.useState(!1);O.useEffect(()=>{const s=setTimeout(()=>I(!1),200);return()=>clearTimeout(s)},[]);const u=Q(Z,M),p=X(H),o=me(),T=ee(M,H,Y),S=se(M,H,Y),c=O.useMemo(()=>he(le,M,K,q,ce),[]),v=O.useMemo(()=>{const s=new Date().toISOString().split("T")[0],k=new Set(q.filter(h=>h.status==="submitted").map(h=>h.sessionId));return K.filter(h=>h.date<s&&!k.has(h.id)).length},[]);return t?e.jsxs("div",{className:"p-6 space-y-8",children:[e.jsxs("div",{children:[e.jsx(d,{className:"h-8 w-64 mb-2"}),e.jsx(d,{className:"h-5 w-96"})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsx(d,{className:"h-24"}),e.jsx(d,{className:"h-24"}),e.jsx(d,{className:"h-24"})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(d,{className:"h-24"}),e.jsx(d,{className:"h-24"}),e.jsx(d,{className:"h-24"}),e.jsx(d,{className:"h-24"})]}),e.jsx(d,{className:"h-48 w-full"})]}):e.jsxs("div",{className:"p-6 space-y-8",children:[g&&e.jsxs(ne,{variant:"destructive",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx(ae,{children:"Something went wrong"}),e.jsxs(ie,{children:["We couldn't load the dashboard."," ",e.jsx(re,{variant:"link",className:"p-0 h-auto font-medium",onClick:()=>R(!1),children:"Try again"})]})]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Admin Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Operations overview: people, finance, and pending actions."})]}),(v>0||o.length>0)&&e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Pending actions"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[v>0&&e.jsxs(F,{to:"/admin/session-reports",className:"inline-flex items-center gap-2 rounded-lg border bg-card px-4 py-3 text-sm font-medium hover:bg-muted/50 transition-colors",children:[e.jsx("span",{className:"text-muted-foreground",children:"Session reports missing:"}),e.jsx("span",{className:"text-primary",children:v}),e.jsx("span",{className:"text-muted-foreground",children:"→ View"})]}),o.length>0&&e.jsxs(F,{to:"/admin/account-approvals",className:"inline-flex items-center gap-2 rounded-lg border bg-card px-4 py-3 text-sm font-medium hover:bg-muted/50 transition-colors",children:[e.jsx("span",{className:"text-muted-foreground",children:"Account approvals:"}),e.jsx("span",{className:"text-primary",children:o.length}),e.jsx("span",{className:"text-muted-foreground",children:"→ View"})]})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Overview — active partners"}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3 mb-4",children:[e.jsx(l,{title:"Active schools",value:c.activeSchools}),e.jsx(l,{title:"Active organisations",value:c.activeOrganisations}),e.jsx(l,{title:"Active Miradi sites",value:c.activeMiradis})]}),e.jsxs(f,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Partners"}),e.jsx(P,{children:"Active organisations with learner counts (schools, organisations, Miradi)."})]}),e.jsx(b,{children:c.partners.length===0?e.jsx("p",{className:"text-sm text-muted-foreground py-4",children:"No active partners."}):e.jsxs(L,{children:[e.jsx(w,{children:e.jsxs(m,{children:[e.jsx(a,{children:"Organisation name"}),e.jsx(a,{children:"Type"}),e.jsx(a,{className:"text-right",children:"Active learners"})]})}),e.jsx(E,{children:c.partners.map(s=>e.jsxs(m,{children:[e.jsx(i,{className:"font-medium",children:s.organisationName}),e.jsx(i,{children:e.jsx(A,{variant:"secondary",children:je[s.type]??s.type})}),e.jsx(i,{className:"text-right",children:s.activeLearners})]},s.organisationId))})]})})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Learning tracks"}),e.jsxs(f,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Learners by track"}),e.jsx(P,{children:"Counts by learning track. Where a learner has no track set, it is inferred from recent session reports for that learner."})]}),e.jsx(b,{children:e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-3",children:c.learnersByTrack.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border px-3 py-2 text-sm",children:[e.jsx("span",{className:"font-medium",children:s.learningTrackName}),e.jsx("span",{className:"text-muted-foreground tabular-nums",children:s.learnerCount})]},s.learningTrackId))})})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"People"}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(l,{title:"Active learners",value:u.activeLearners}),e.jsx(l,{title:"Active educators",value:u.activeEducators}),e.jsx(l,{title:"Active parents",value:u.activeParents}),e.jsx(l,{title:"Pending accounts",value:u.pendingAccounts,description:"Awaiting approval"})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Finance"}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(l,{title:"Total invoiced",value:j(p.totalInvoiced)}),e.jsx(l,{title:"Total collected",value:j(p.totalCollected)}),e.jsx(l,{title:"Total pending",value:j(p.totalPending)}),e.jsx(l,{title:"Learners with pending payments",value:p.learnersWithPendingPayments})]})]}),e.jsx("section",{children:e.jsxs(f,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Pending account approvals"}),e.jsx(P,{children:"Users awaiting approval. Manage in Account Approvals when available."})]}),e.jsx(b,{children:o.length===0?e.jsx("p",{className:"text-sm text-muted-foreground py-4",children:"No pending approvals."}):e.jsxs(L,{children:[e.jsx(w,{children:e.jsxs(m,{children:[e.jsx(a,{children:"Name"}),e.jsx(a,{children:"Email"}),e.jsx(a,{children:"Role"}),e.jsx(a,{children:"Created"})]})}),e.jsx(E,{children:o.map(s=>e.jsxs(m,{children:[e.jsx(i,{className:"font-medium",children:s.name}),e.jsx(i,{children:s.email??"—"}),e.jsx(i,{className:"capitalize",children:s.role}),e.jsx(i,{children:s.createdAt?xe(s.createdAt):"—"})]},s.id))})]})})]})}),e.jsx("section",{children:e.jsxs(f,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Learners with pending payments"}),e.jsx(P,{children:"Outstanding invoice amounts. Members: billed to parent; Partner org: billed to organisation."})]}),e.jsx(b,{children:T.length===0?e.jsx("p",{className:"text-sm text-muted-foreground py-4",children:"No learners with pending payments."}):e.jsxs(L,{children:[e.jsx(w,{children:e.jsxs(m,{children:[e.jsx(a,{children:"Learner"}),e.jsx(a,{children:"Payer type"}),e.jsx(a,{children:"Payer / contact"}),e.jsx(a,{children:"Phone"}),e.jsx(a,{children:"Email"}),e.jsx(a,{className:"text-right",children:"Invoiced"}),e.jsx(a,{className:"text-right",children:"Paid"}),e.jsx(a,{className:"text-right",children:"Pending"}),e.jsx(a,{children:"Status"})]})}),e.jsx(E,{children:T.map(s=>e.jsx(ge,{row:s},s.learnerId))})]})})]})}),S.length>0&&e.jsx("section",{children:e.jsxs(f,{children:[e.jsxs(N,{children:[e.jsx(y,{children:"Organisations with pending payments"}),e.jsx(P,{children:"Partner schools/orgs with outstanding invoice amounts (billed per organisation)."})]}),e.jsx(b,{children:e.jsxs(L,{children:[e.jsx(w,{children:e.jsxs(m,{children:[e.jsx(a,{children:"Organisation"}),e.jsx(a,{children:"Contact"}),e.jsx(a,{children:"Phone"}),e.jsx(a,{children:"Email"}),e.jsx(a,{className:"text-right",children:"Pending"}),e.jsx(a,{children:"Status"})]})}),e.jsx(E,{children:S.map(s=>e.jsxs(m,{children:[e.jsx(i,{className:"font-medium",children:s.organizationName}),e.jsx(i,{children:s.contactPerson}),e.jsx(i,{children:s.contactPhone||"—"}),e.jsx(i,{children:s.contactEmail||"—"}),e.jsx(i,{className:"text-right font-medium",children:j(s.pendingAmount)}),e.jsx(i,{children:s.isOverdue?e.jsx(A,{variant:"destructive",children:"Overdue"}):e.jsx(A,{variant:"secondary",children:"Pending"})})]},s.organizationId))})]})})]})})]})}function ge({row:t}){return e.jsxs(m,{children:[e.jsx(i,{className:"font-medium",children:e.jsx(F,{to:`/admin/learners/${t.learnerId}`,className:"text-primary hover:underline",children:t.learnerName})}),e.jsx(i,{children:e.jsx(A,{variant:"outline",children:t.enrolmentType==="member"?"Member":"Partner org"})}),e.jsx(i,{children:t.payerLabel}),e.jsx(i,{children:t.payerPhone||"—"}),e.jsx(i,{children:t.payerEmail||"—"}),e.jsx(i,{className:"text-right",children:j(t.totalInvoiced)}),e.jsx(i,{className:"text-right",children:j(t.totalPaid)}),e.jsx(i,{className:"text-right font-medium",children:j(t.pendingAmount)}),e.jsx(i,{children:t.isOverdue?e.jsx(A,{variant:"destructive",children:"Overdue"}):e.jsx(A,{variant:"secondary",children:"Pending"})})]})}export{pe as default};
